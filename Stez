-- ============================================================
-- SYSTEME DE WHITELIST (@USERNAME)
-- ============================================================

local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Liste des comptes autorisés
local whitelist = {
    "charlyto68", 
}

local function checkWhitelist()
    local myName = string.lower(player.Name)
    for _, name in ipairs(whitelist) do
        if myName == string.lower(name) then
            return true
        end
    end
    return false
end

-- Vérification de sécurité avant de charger le reste
if not checkWhitelist() then
    local sg = Instance.new("ScreenGui", player.PlayerGui)
    local txt = Instance.new("TextLabel", sg)
    txt.Size = UDim2.new(1, 0, 1, 0)
    txt.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    txt.BackgroundTransparency = 0.3
    txt.Text = "ACCÈS REFUSÉ : @" .. player.Name .. " n'est pas autorisé."
    txt.TextColor3 = Color3.fromRGB(255, 50, 50)
    txt.Font = Enum.Font.GothamBold
    txt.TextSize = 22
    
    warn("[ACCÈS BLOQUÉ] Tentative par : @" .. player.Name)
    task.wait(4)
    sg:Destroy()
    return -- Arrête l'exécution ici
end

-- ============================================================
-- stez Instant Steal + Desync & NoAnim Toggle (SI WHITELISTÉ)
-- ============================================================

local ProximityPromptService = game:GetService("ProximityPromptService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

if _G.stezHubInstantStealLoaded then 
	warn("stez Instant Steal already loaded!")
	return 
end
_G.stezHubInstantStealLoaded = true

-- CONFIG DESYNC FFLAGS
local FFlags = {
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    LargeReplicatorWrite5 = true,
    LargeReplicatorEnabled9 = true,
    AngularVelociryLimit = 360,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    S2PhysicsSenderRate = 15000,
    DisableDPIScale = true,
    MaxDataPacketPerSend = 2147483647,
    PhysicsSenderMaxBandwidthBps = 20000,
    TimestepArbiterHumanoidLinearVelThreshold = 21,
    MaxMissedWorldStepsRemembered = -2147483648,
    PlayerHumanoidPropertyUpdateRestrict = true,
    SimDefaultHumanoidTimestepMultiplier = 0,
    StreamJobNOUVolumeLengthCap = 2147483647,
    DebugSendDistInSteps = -2147483648,
    GameNetDontSendRedundantNumTimes = 1,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    LargeReplicatorSerializeRead3 = true,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
    CheckPVCachedVelThresholdPercent = 10,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    InterpolationFrameVelocityThresholdMillionth = 5,
    StreamJobNOUVolumeCap = 2147483647,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    CheckPVCachedRotVelThresholdPercent = 10,
    WorldStepMax = 30,
    InterpolationFramePositionThresholdMillionth = 5,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    NextGenReplicatorEnabledWrite4 = true,
    TimestepArbiterOmegaThou = 1073741823,
    MaxAcceptableUpdateDelay = 1,
    LargeReplicatorSerializeWrite4 = true
}

local defaultFFlags = {
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = 8,
    LargeReplicatorWrite5 = false,
    LargeReplicatorEnabled9 = false,
    AngularVelociryLimit = 180,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 100,
    S2PhysicsSenderRate = 60,
    DisableDPIScale = false,
    MaxDataPacketPerSend = 1024,
    PhysicsSenderMaxBandwidthBps = 10000,
    TimestepArbiterHumanoidLinearVelThreshold = 10,
    MaxMissedWorldStepsRemembered = 10,
    PlayerHumanoidPropertyUpdateRestrict = false,
    SimDefaultHumanoidTimestepMultiplier = 1,
    StreamJobNOUVolumeLengthCap = 1000,
    DebugSendDistInSteps = 10,
    GameNetDontSendRedundantNumTimes = 10,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 50,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 100,
    LargeReplicatorSerializeRead3 = false,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 100,
    CheckPVCachedVelThresholdPercent = 50,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 100,
    GameNetDontSendRedundantDeltaPositionMillionth = 100,
    InterpolationFrameVelocityThresholdMillionth = 100,
    StreamJobNOUVolumeCap = 1000,
    InterpolationFrameRotVelocityThresholdMillionth = 100,
    CheckPVCachedRotVelThresholdPercent = 50,
    WorldStepMax = 60,
    InterpolationFramePositionThresholdMillionth = 100,
    TimestepArbiterHumanoidTurningVelThreshold = 10,
    SimOwnedNOUCountThresholdMillionth = 1000,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = 8,
    NextGenReplicatorEnabledWrite4 = false,
    TimestepArbiterOmegaThou = 1000,
    MaxAcceptableUpdateDelay = 10,
    LargeReplicatorSerializeWrite4 = false
}

local desyncActive = true

local function applyFFlags(flags)
    for name, value in pairs(flags) do
        pcall(function()
            setfflag(tostring(name), tostring(value))
        end)
    end
end

local function respawn(plr)
    local char = plr.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum:ChangeState(Enum.HumanoidStateType.Dead) end
        char:ClearAllChildren()
        local newChar = Instance.new("Model", workspace)
        plr.Character = newChar
        task.wait()
        plr.Character = char
        newChar:Destroy()
    end
end

local pos1, pos2 = nil, nil
local beam1, beam2, part1, part2

local targetPositions = {
	Vector3.new(-481.88, -3.79, 138.02), Vector3.new(-481.75, -3.79, 89.18),
	Vector3.new(-481.82, -3.79, 30.95), Vector3.new(-481.75, -3.79, -17.79),
	Vector3.new(-481.80, -3.79, -76.06), Vector3.new(-481.72, -3.79, -124.70),
	Vector3.new(-337.45, -3.85, -124.72), Vector3.new(-337.37, -3.85, -76.07),
	Vector3.new(-337.46, -3.79, -17.72), Vector3.new(-337.41, -3.79, 30.92),
	Vector3.new(-337.32, -3.79, 89.02), Vector3.new(-337.27, -3.79, 137.90),
	Vector3.new(-337.45, -3.79, 196.29), Vector3.new(-337.37, -3.79, 244.91),
	Vector3.new(-481.72, -3.79, 196.21), Vector3.new(-481.76, -3.79, 244.92)
}

-- GUI Creation
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "STEZHubUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(220, 185)
frame.Position = UDim2.fromScale(0.5, 0.5)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -12, 0, 28)
title.Position = UDim2.fromOffset(6, 6)
title.BackgroundTransparency = 1
title.Text = "STEZHUB | INSTANT STEAL"
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.new(1,1,1)
title.TextSize = 14

local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(1, -12, 0, 22)
status.Position = UDim2.fromOffset(6, 42)
status.BackgroundTransparency = 1
status.Text = "Waiting for Steal…"
status.Font = Enum.Font.Gotham
status.TextColor3 = Color3.fromRGB(190, 190, 190)
status.TextSize = 12

local function makeButton(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(1, -24, 0, 36)
	b.Position = UDim2.fromOffset(12, y)
	b.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
	b.Text = text
	b.Font = Enum.Font.GothamMedium
	b.TextSize = 14
	b.TextColor3 = Color3.fromRGB(235, 235, 235)
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)
	return b
end

local btn1 = makeButton("Set Position", 80)
local btnDesync = makeButton("Desync: ON", 125)
btnDesync.BackgroundColor3 = Color3.fromRGB(0, 150, 0)

-- LOGIQUE DESYNC
local function toggleDesync(active)
    if active then
        applyFFlags(FFlags)
        btnDesync.Text = "Desync: ON"
        btnDesync.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        if player.Character and player.Character:FindFirstChild("Animate") then
            player.Character.Animate.Disabled = true
        end
    else
        applyFFlags(defaultFFlags)
        btnDesync.Text = "Desync: OFF"
        btnDesync.BackgroundColor3 = Color3.fromRGB(60, 30, 30)
        if player.Character and player.Character:FindFirstChild("Animate") then
            player.Character.Animate.Disabled = false
        end
    end
end

btnDesync.MouseButton1Click:Connect(function()
    desyncActive = not desyncActive
    toggleDesync(desyncActive)
end)

-- LOGIQUE TP BEAMS
local function createBeam(position, color, index)
	local char = player.Character
	if not char or not char:FindFirstChild("HumanoidRootPart") then return end
	local p = Instance.new("Part", workspace)
	p.Anchored, p.CanCollide, p.Transparency = true, false, 1
	p.CFrame = CFrame.new(position)
	local a0 = Instance.new("Attachment", p)
	local a1 = Instance.new("Attachment", char.HumanoidRootPart)
	local b = Instance.new("Beam", workspace)
	b.Attachment0, b.Attachment1, b.Width0, b.Width1 = a0, a1, 0.12, 0.12
	b.FaceCamera, b.Color = true, ColorSequence.new(color)
	if index == 1 then if beam1 then beam1:Destroy() end if part1 then part1:Destroy() end beam1, part1 = b, p
	else if beam2 then beam2:Destroy() end if part2 then part2:Destroy() end beam2, part2 = b, p end
end

btn1.MouseButton1Click:Connect(function()
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if hrp then 
        pos1 = hrp.CFrame 
        createBeam(pos1.Position, Color3.fromRGB(0,170,255), 1) 
        status.Text = "Position 1 Set ✓" 
    end
end)

task.spawn(function()
	while gui.Parent do
		task.wait(1)
		local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if hrp then
			local closest, dist = nil, math.huge
			for _, v in ipairs(targetPositions) do
				local d = (hrp.Position - v).Magnitude
				if d < dist then dist = d closest = v end
			end
			if closest then pos2 = CFrame.new(closest) createBeam(pos2.Position, Color3.fromRGB(255,140,0), 2) end
		end
	end
end)

ProximityPromptService.PromptButtonHoldEnded:Connect(function(prompt, who)
	if who ~= player or (prompt.Name ~= "Steal" and prompt.ActionText ~= "Steal") then return end
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if hrp then
		if pos1 then hrp.CFrame = pos1 end
		if pos2 then task.wait(0.05) hrp.CFrame = pos2 end
		status.Text = "Steal Complete ✓"
		task.wait(2) status.Text = "Waiting for Steal…"
	end
end)

-- DISCORD
local discord = Instance.new("TextLabel", frame)
discord.Size = UDim2.new(1, 0, 0, 16)
discord.Position = UDim2.fromOffset(0, 165)
discord.BackgroundTransparency = 1
discord.Text = "https://discord.gg/rE5FjgJVHr"
discord.Font = Enum.Font.GothamMedium
discord.TextSize = 10
discord.TextXAlignment = Enum.TextXAlignment.Center
discord.TextColor3 = Color3.fromRGB(0, 255, 0)

-- INITIALISATION
toggleDesync(true)
respawn(player)
